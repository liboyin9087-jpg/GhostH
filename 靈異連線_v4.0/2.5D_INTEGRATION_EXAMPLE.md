# 2.5D 過渡系統整合範例
# Integration Example for 2.5D Transition System

## 快速開始

### 1. 在 GameShell 中整合

```typescript
import React, { Suspense, lazy } from 'react'
import { useSceneTransition, shouldUse3DTransition } from './hooks/useSceneTransition'
import { useGameSettings } from './components/SettingsMenu'
import { usePrefersReducedMotion } from './hooks/usePrefersReducedMotion'

// 動態載入 3D 組件（優化 bundle size）
const CorridorTransition = lazy(() => 
  import('./components/CorridorTransition').then(module => ({
    default: module.CorridorTransition
  }))
)

function GameShell() {
  const [currentScene, setCurrentScene] = useState<SceneId>('title_archive')
  const { settings } = useGameSettings()
  const { 
    transition, 
    startTransition, 
    completeTransition, 
    resetTransition 
  } = useSceneTransition()
  const reducedMotion = usePrefersReducedMotion()

  // 場景切換處理
  const handleMoveToScene = useCallback((targetScene: SceneId) => {
    const use3D = settings.enable3DTransitions && 
                  shouldUse3DTransition(currentScene, targetScene)
    
    if (use3D) {
      // 使用 3D 過渡
      startTransition(currentScene, targetScene, true)
    } else {
      // 直接切換
      setCurrentScene(targetScene)
    }
  }, [currentScene, settings.enable3DTransitions, startTransition])

  // 3D 過渡完成處理
  const handle3DTransitionComplete = useCallback(() => {
    completeTransition()
    
    // 短暫延遲後切換場景並重置
    setTimeout(() => {
      if (transition.toScene) {
        setCurrentScene(transition.toScene)
        resetTransition()
      }
    }, 500)
  }, [transition.toScene, completeTransition, resetTransition])

  return (
    <>
      {/* 3D 走廊過渡 */}
      {transition.state === 'transitioning' && transition.enabled && (
        <Suspense fallback={
          <div style={{
            position: 'fixed',
            inset: 0,
            background: '#000',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            color: '#fff',
            fontFamily: 'VT323, monospace'
          }}>
            ▶ LOADING TRANSITION...
          </div>
        }>
          <CorridorTransition
            fromScene={transition.fromScene!}
            toScene={transition.toScene!}
            onComplete={handle3DTransitionComplete}
            reducedMotion={reducedMotion}
          />
        </Suspense>
      )}

      {/* 正常遊戲內容 */}
      {transition.state !== 'transitioning' && (
        <div className="game-content">
          {/* 當前場景渲染 */}
          <SceneRenderer sceneId={currentScene} />
          
          {/* 移動按鈕 */}
          <button onClick={() => handleMoveToScene('nurse_station')}>
            前往護理站
          </button>
        </div>
      )}
    </>
  )
}
```

### 2. 簡化版整合（不使用動態載入）

```typescript
import { CorridorTransition } from './components/CorridorTransition'

function SimpleIntegration() {
  const [showTransition, setShowTransition] = useState(false)
  const [targetScene, setTargetScene] = useState<SceneId>('nurse_station')

  const startTransition = (to: SceneId) => {
    setTargetScene(to)
    setShowTransition(true)
  }

  const handleComplete = () => {
    setShowTransition(false)
    // 切換到目標場景
    switchToScene(targetScene)
  }

  return (
    <>
      {showTransition && (
        <CorridorTransition
          fromScene="corridor_b1"
          toScene={targetScene}
          onComplete={handleComplete}
        />
      )}
      {!showTransition && (
        <div>正常遊戲內容</div>
      )}
    </>
  )
}
```

### 3. 條件式啟用

```typescript
// 根據設定決定是否使用 3D 過渡
function ConditionalTransition() {
  const { settings } = useGameSettings()
  
  const changeScene = (from: SceneId, to: SceneId) => {
    // 檢查是否啟用
    if (!settings.enable3DTransitions) {
      switchDirectly(to)
      return
    }
    
    // 檢查是否適用
    if (!shouldUse3DTransition(from, to)) {
      switchDirectly(to)
      return
    }
    
    // 使用 3D 過渡
    show3DTransition(from, to)
  }
  
  return <div>...</div>
}
```

## 進階用法

### 自定義走廊樣式

```typescript
// 為不同場景創建不同的走廊
const corridorStyles = {
  'corridor_b1->nurse_station': {
    wallColor: '#2a2520',
    lightColor: '#ff9966',
    fogDensity: 0.05
  },
  'nurse_station->morgue': {
    wallColor: '#1a1520',
    lightColor: '#66ccff',
    fogDensity: 0.08
  }
}

<CorridorTransition
  fromScene={from}
  toScene={to}
  style={corridorStyles[`${from}->${to}`]}
  onComplete={handleComplete}
/>
```

### 添加音效

```typescript
function TransitionWithAudio() {
  const audioRef = useRef<HTMLAudioElement>(null)
  
  useEffect(() => {
    if (showTransition && audioRef.current) {
      audioRef.current.play()
    }
  }, [showTransition])
  
  return (
    <>
      <audio ref={audioRef} src="/audio/corridor_ambient.mp3" loop />
      {showTransition && <CorridorTransition ... />}
    </>
  )
}
```

### 添加載入進度

```typescript
function TransitionWithProgress() {
  const [loadProgress, setLoadProgress] = useState(0)
  
  useEffect(() => {
    if (showTransition) {
      // 模擬載入進度
      const interval = setInterval(() => {
        setLoadProgress(p => Math.min(100, p + 10))
      }, 100)
      return () => clearInterval(interval)
    }
  }, [showTransition])
  
  return (
    <>
      {loadProgress < 100 && (
        <LoadingScreen progress={loadProgress} />
      )}
      {loadProgress === 100 && (
        <CorridorTransition ... />
      )}
    </>
  )
}
```

## 效能優化技巧

### 1. 預載入

```typescript
// 在遊戲開始時預載入 3D 組件
useEffect(() => {
  if (settings.enable3DTransitions) {
    import('./components/CorridorTransition')
  }
}, [settings.enable3DTransitions])
```

### 2. 記憶化

```typescript
const MemoizedTransition = memo(CorridorTransition)

<MemoizedTransition
  fromScene={from}
  toScene={to}
  onComplete={handleComplete}
/>
```

### 3. 資源管理

```typescript
useEffect(() => {
  return () => {
    // 清理 Three.js 資源
    // 這通常由組件內部處理，但可以額外確保
  }
}, [])
```

## 測試建議

### 單元測試

```typescript
import { renderHook } from '@testing-library/react-hooks'
import { useSceneTransition } from './hooks/useSceneTransition'

test('should start transition', () => {
  const { result } = renderHook(() => useSceneTransition())
  
  act(() => {
    result.current.startTransition('corridor_b1', 'nurse_station', true)
  })
  
  expect(result.current.isTransitioning).toBe(true)
})
```

### 整合測試

```typescript
test('should complete full transition flow', async () => {
  const { getByText } = render(<GameShell />)
  
  // 開始過渡
  fireEvent.click(getByText('前往護理站'))
  
  // 等待過渡完成
  await waitFor(() => {
    expect(getByText('護理站')).toBeInTheDocument()
  })
})
```

## 故障排除

### Debug模式

```typescript
const CorridorTransitionDebug = (props) => {
  console.log('Transition props:', props)
  
  return (
    <>
      <div style={{ position: 'fixed', top: 0, left: 0, zIndex: 9999 }}>
        <div>From: {props.fromScene}</div>
        <div>To: {props.toScene}</div>
      </div>
      <CorridorTransition {...props} />
    </>
  )
}
```

### 效能監控

```typescript
useEffect(() => {
  const start = performance.now()
  
  return () => {
    const duration = performance.now() - start
    console.log('Transition duration:', duration, 'ms')
  }
}, [])
```

## 常見問題

**Q: 為什麼過渡沒有顯示？**
A: 檢查 `enable3DTransitions` 設定和 `shouldUse3DTransition` 返回值

**Q: 如何跳過特定場景的過渡？**
A: 在 `shouldUse3DTransition` 中添加條件

**Q: 可以自定義走廊長度嗎？**
A: 是的，修改 `CorridorContent` 組件中的幾何體參數

**Q: 支援觸控設備嗎？**
A: 支援，但體驗較鍵盤滑鼠差，建議添加虛擬搖桿

## 更多資源

- [完整文檔](./2.5D_TRANSITION_DOCUMENTATION.md)
- [Three.js官方教程](https://threejs.org/manual/)
- [React Three Fiber範例](https://docs.pmnd.rs/react-three-fiber/getting-started/examples)
