# 2.5D 過渡系統文檔
# 2.5D Transition System Documentation

## 版本 4.1
日期: 2025年12月19日

## 概述

2.5D 過渡系統為《靈異連線》添加了3D第一人稱走廊過渡，在保持現有2D場景系統的同時，增強了場景切換的沉浸感。

## 系統架構

### 核心組件

#### 1. CorridorTransition.tsx
3D走廊過渡場景的主要組件。

**功能**:
- 第一人稱視角控制
- WASD移動
- 滑鼠視角控制（PointerLock）
- VHS風格後處理效果
- 自動檢測到達終點

**技術細節**:
```typescript
interface CorridorTransitionProps {
  fromScene: string      // 來源場景
  toScene: string        // 目標場景
  onComplete: () => void // 完成回調
  reducedMotion?: boolean // 減少動畫
}
```

#### 2. useSceneTransition.ts
場景過渡狀態管理Hook。

**API**:
```typescript
const {
  transition,           // 當前過渡狀態
  startTransition,      // 開始過渡
  completeTransition,   // 完成過渡
  resetTransition,      // 重置狀態
  shouldShow3DTransition, // 是否顯示3D過渡
  isTransitioning      // 是否正在過渡
} = useSceneTransition()
```

**過渡狀態**:
- `idle` - 閒置
- `transitioning` - 過渡中
- `complete` - 完成

### 設定選項

#### GameSettings新增欄位
```typescript
enable3DTransitions: boolean // 預設: true
```

使用者可以在設定選單中開關3D過渡功能。

## 視覺效果

### 3D走廊設計

#### 環境元素
1. **地板/天花板/牆壁**: 暗色調醫院風格
2. **照明**: 5個昏暗的點光源（橙黃色）
3. **裝飾**: 管道、遠處的門
4. **霧效**: 增強深度感

#### 尺寸規格
- 走廊寬度: 5米
- 天花板高度: 3.5米
- 總長度: 25米
- 玩家視角高度: 1.6米

### VHS後處理效果

使用 `@react-three/postprocessing` 實現：

1. **雜訊 (Noise)**: 
   - 透明度: 0.2
   - 混合模式: OVERLAY

2. **暈影 (Vignette)**:
   - 偏移: 0.3
   - 暗度: 0.6

3. **色差 (Chromatic Aberration)**:
   - 偏移: [0.002, 0.002]

## 使用指南

### 整合到現有專案

#### 步驟 1: 安裝依賴

```bash
npm install three @react-three/fiber @react-three/drei @react-three/postprocessing --legacy-peer-deps
```

#### 步驟 2: 在場景切換時使用

```typescript
import { CorridorTransition } from './components/CorridorTransition'
import { useSceneTransition, shouldUse3DTransition } from './hooks/useSceneTransition'

function GameComponent() {
  const { transition, startTransition, completeTransition, resetTransition } = useSceneTransition()
  const settings = useGameSettings()

  const handleSceneChange = (fromScene: SceneId, toScene: SceneId) => {
    if (settings.enable3DTransitions && shouldUse3DTransition(fromScene, toScene)) {
      startTransition(fromScene, toScene, true)
    } else {
      // 直接切換場景
      switchSceneDirectly(toScene)
    }
  }

  const handleTransitionComplete = () => {
    completeTransition()
    // 延遲後重置並切換到目標場景
    setTimeout(() => {
      switchSceneDirectly(transition.toScene!)
      resetTransition()
    }, 500)
  }

  return (
    <>
      {transition.state === 'transitioning' && transition.enabled && (
        <CorridorTransition
          fromScene={transition.fromScene!}
          toScene={transition.toScene!}
          onComplete={handleTransitionComplete}
          reducedMotion={usePrefersReducedMotion()}
        />
      )}
      {/* 正常遊戲內容 */}
    </>
  )
}
```

## 控制方式

### 鍵盤
- **W / ↑**: 向前移動
- **S / ↓**: 向後移動
- **A / ←**: 向左移動
- **D / →**: 向右移動

### 滑鼠
- **點擊畫面**: 鎖定滑鼠指標
- **移動滑鼠**: 控制視角
- **ESC**: 解鎖滑鼠

## 效能優化

### Bundle大小影響
- Three.js: ~600 KB
- React Three Fiber: ~80 KB
- Drei輔助函式: ~120 KB
- Postprocessing: ~100 KB
- **總增加**: ~900 KB (未壓縮)

### 優化策略

#### 1. 動態載入
建議使用React.lazy延遲載入3D組件：

```typescript
const CorridorTransition = React.lazy(() => 
  import('./components/CorridorTransition')
)

// 使用時
<Suspense fallback={<LoadingScreen />}>
  <CorridorTransition ... />
</Suspense>
```

#### 2. 簡化場景
- 使用基本幾何體而非複雜模型
- 限制光源數量（5個點光源）
- 禁用抗鋸齒（符合VHS風格）

#### 3. 紋理優化
- 使用小尺寸紋理（512x512）
- 考慮程序化材質而非圖片

## 相容性

### 瀏覽器支援
- Chrome 90+: ✓ 完全支援
- Firefox 85+: ✓ 完全支援
- Safari 15+: ✓ 完全支援
- Edge 90+: ✓ 完全支援

### 行動裝置
- iOS 15+: ✓ 支援（觸控螢幕代替滑鼠）
- Android Chrome: ✓ 支援
- 效能注意: 建議中高階設備

### WebGL要求
- WebGL 2.0
- 自動降級到 WebGL 1.0（功能受限）

## 無障礙功能

### Reduced Motion支援
當使用者啟用減少動畫偏好時：
- 禁用後處理效果
- 簡化視覺效果
- 保持基本功能

### 替代方案
使用者可以在設定中關閉3D過渡，回到傳統場景切換。

## 故障排除

### 常見問題

#### 1. 畫面卡頓
**原因**: 設備效能不足
**解決**: 
- 關閉後處理效果
- 降低分辨率
- 禁用陰影

#### 2. 滑鼠鎖定失敗
**原因**: 瀏覽器安全限制
**解決**: 
- 確保使用者已與頁面互動
- 檢查瀏覽器權限設定

#### 3. 黑屏或空白
**原因**: WebGL初始化失敗
**解決**:
- 檢查瀏覽器WebGL支援
- 更新顯卡驅動
- 嘗試不同瀏覽器

## 未來改進

### 計劃功能
1. **多樣化走廊**: 不同場景有不同走廊風格
2. **互動元素**: 走廊中的可互動物件
3. **環境音效**: 腳步聲、回音、遠處聲響
4. **動態事件**: 走廊中的隨機驚嚇事件
5. **觸控支援優化**: 虛擬搖桿控制

### 實驗性功能
1. **VR支援**: WebXR整合
2. **多人模式**: 網路同步
3. **自定義場景**: 讓玩家建立走廊

## 開發者資源

### 參考資料
- [Three.js文檔](https://threejs.org/docs/)
- [React Three Fiber](https://docs.pmnd.rs/react-three-fiber/)
- [Drei輔助函式](https://github.com/pmndrs/drei)
- [Postprocessing](https://github.com/pmndrs/postprocessing)

### 相關檔案
- `/src/components/CorridorTransition.tsx` - 主要組件
- `/src/hooks/useSceneTransition.ts` - 狀態管理
- `/src/components/SettingsMenu.tsx` - 設定選項

## 授權與貢獻

此功能為《靈異連線》v4.1的一部分，遵循專案的MIT授權。

### 致謝
- Three.js團隊
- Pmndrs團隊（React Three Fiber生態系統）
- 測試與回饋的社群成員

## 變更日誌

### v4.1.0 (2025-12-19)
- ✨ 初始實作2.5D過渡系統
- ✨ 添加3D走廊組件
- ✨ 整合設定選項
- 📝 完整文檔

---

**注意**: 這是實驗性功能，可能需要根據使用者反饋進行調整。
